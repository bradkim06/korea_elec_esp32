#include "fir_filter.h"

#include <math.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "dsps_fir.h"
#include "esp_dsp.h"
#include "signal_processing.h"

#define NUM_TAPS 1024

static const float fir_coeffs[NUM_TAPS] = {
    -0.00002836f, -0.00004716f, -0.00000214f, 0.00004797f,  0.00003743f,
    -0.00001926f, -0.00004616f, -0.00000645f, 0.00004832f,  0.00004624f,
    -0.00000950f, -0.00004428f, -0.00001072f, 0.00004796f,  0.00005473f,
    0.00000095f,  -0.00004141f, -0.00001486f, 0.00004690f,  0.00006285f,
    0.00001213f,  -0.00003746f, -0.00001876f, 0.00004516f,  0.00007057f,
    0.00002404f,  -0.00003229f, -0.00002229f, 0.00004273f,  0.00007780f,
    0.00003669f,  -0.00002577f, -0.00002532f, 0.00003963f,  0.00008447f,
    0.00005005f,  -0.00001777f, -0.00002766f, 0.00003590f,  0.00009044f,
    0.00006407f,  -0.00000816f, -0.00002913f, 0.00003157f,  0.00009561f,
    0.00007866f,  0.00000318f,  -0.00002951f, 0.00002672f,  0.00009982f,
    0.00009368f,  0.00001634f,  -0.00002854f, 0.00002145f,  0.00010295f,
    0.00010897f,  0.00003139f,  -0.00002599f, 0.00001591f,  0.00010483f,
    0.00012430f,  0.00004835f,  -0.00002158f, 0.00001027f,  0.00010536f,
    0.00013943f,  0.00006720f,  -0.00001504f, 0.00000476f,  0.00010441f,
    0.00015406f,  0.00008786f,  -0.00000612f, -0.00000035f, 0.00010192f,
    0.00016786f,  0.00011018f,  0.00000543f,  -0.00000474f, 0.00009785f,
    0.00018046f,  0.00013394f,  0.00001981f,  -0.00000807f, 0.00009220f,
    0.00019151f,  0.00015885f,  0.00003717f,  -0.00000994f, 0.00008507f,
    0.00020063f,  0.00018456f,  0.00005763f,  -0.00000996f, 0.00007658f,
    0.00020746f,  0.00021061f,  0.00008120f,  -0.00000769f, 0.00006696f,
    0.00021165f,  0.00023650f,  0.00010783f,  -0.00000271f, 0.00005649f,
    0.00021290f,  0.00026166f,  0.00013737f,  0.00000539f,  0.00004553f,
    0.00021096f,  0.00028547f,  0.00016957f,  0.00001699f,  0.00003453f,
    0.00020567f,  0.00030726f,  0.00020405f,  0.00003241f,  0.00002398f,
    0.00019692f,  0.00032636f,  0.00024033f,  0.00005192f,  0.00001443f,
    0.00018472f,  0.00034208f,  0.00027781f,  0.00007568f,  0.00000651f,
    0.00016918f,  0.00035374f,  0.00031580f,  0.00010376f,  0.00000083f,
    0.00015053f,  0.00036071f,  0.00035348f,  0.00013611f,  -0.00000196f,
    0.00012911f,  0.00036242f,  0.00038994f,  0.00017253f,  -0.00000123f,
    0.00010539f,  0.00035838f,  0.00042421f,  0.00021268f,  0.00000362f,
    0.00007995f,  0.00034821f,  0.00045524f,  0.00025606f,  0.00001311f,
    0.00005349f,  0.00033165f,  0.00048197f,  0.00030201f,  0.00002770f,
    0.00002680f,  0.00030858f,  0.00050332f,  0.00034971f,  0.00004773f,
    0.00000075f,  0.00027905f,  0.00051822f,  0.00039817f,  0.00007341f,
    -0.00002374f, 0.00024329f,  0.00052566f,  0.00044626f,  0.00010476f,
    -0.00004568f, 0.00020170f,  0.00052472f,  0.00049272f,  0.00014165f,
    -0.00006411f, 0.00015487f,  0.00051457f,  0.00053616f,  0.00018375f,
    -0.00007808f, 0.00010357f,  0.00049456f,  0.00057512f,  0.00023051f,
    -0.00008670f, 0.00004873f,  0.00046419f,  0.00060807f,  0.00028115f,
    -0.00008915f, -0.00000853f, 0.00042317f,  0.00063347f,  0.00033468f,
    -0.00008478f, -0.00006697f, 0.00037144f,  0.00064977f,  0.00038988f,
    -0.00007307f, -0.00012523f, 0.00030919f,  0.00065550f,  0.00044534f,
    -0.00005371f, -0.00018188f, 0.00023685f,  0.00064926f,  0.00049944f,
    -0.00002662f, -0.00023542f, 0.00015515f,  0.00062983f,  0.00055038f,
    0.00000805f,  -0.00028435f, 0.00006507f,  0.00059614f,  0.00059625f,
    0.00004984f,  -0.00032723f, -0.00003215f, 0.00054735f,  0.00063500f,
    0.00009803f,  -0.00036266f, -0.00013501f, 0.00048290f,  0.00066455f,
    0.00015158f,  -0.00038942f, -0.00024179f, 0.00040254f,  0.00068280f,
    0.00020916f,  -0.00040643f, -0.00035058f, 0.00030631f,  0.00068767f,
    0.00026914f,  -0.00041285f, -0.00045929f, 0.00019463f,  0.00067719f,
    0.00032961f,  -0.00040812f, -0.00056572f, 0.00006831f,  0.00064955f,
    0.00038840f,  -0.00039197f, -0.00066762f, -0.00007150f, 0.00060312f,
    0.00044313f,  -0.00036449f, -0.00076270f, -0.00022326f, 0.00053657f,
    0.00049122f,  -0.00032615f, -0.00084874f, -0.00038504f, 0.00044885f,
    0.00052997f,  -0.00027779f, -0.00092362f, -0.00055459f, 0.00033930f,
    0.00055659f,  -0.00022067f, -0.00098540f, -0.00072934f, 0.00020770f,
    0.00056828f,  -0.00015646f, -0.00103237f, -0.00090643f, 0.00005423f,
    0.00056228f,  -0.00008724f, -0.00106314f, -0.00108279f, -0.00012040f,
    0.00053598f,  -0.00001545f, -0.00107664f, -0.00125515f, -0.00031500f,
    0.00048694f,  0.00005609f,  -0.00107226f, -0.00142018f, -0.00052786f,
    0.00041299f,  0.00012427f,  -0.00104983f, -0.00157449f, -0.00075673f,
    0.00031232f,  0.00018570f,  -0.00100967f, -0.00171472f, -0.00099891f,
    0.00018353f,  0.00023679f,  -0.00095264f, -0.00183769f, -0.00125116f,
    0.00002569f,  0.00027382f,  -0.00088016f, -0.00194037f, -0.00150985f,
    -0.00016158f, 0.00029302f,  -0.00079421f, -0.00202007f, -0.00177092f,
    -0.00037809f, 0.00029062f,  -0.00069730f, -0.00207445f, -0.00202999f,
    -0.00062299f, 0.00026298f,  -0.00059250f, -0.00210163f, -0.00228242f,
    -0.00089478f, 0.00020667f,  -0.00048339f, -0.00210026f, -0.00252337f,
    -0.00119129f, 0.00011856f,  -0.00037401f, -0.00206959f, -0.00274791f,
    -0.00150963f, -0.00000412f, -0.00026882f, -0.00200949f, -0.00295112f,
    -0.00184626f, -0.00016364f, -0.00017262f, -0.00192056f, -0.00312815f,
    -0.00219696f, -0.00036171f, -0.00009048f, -0.00180410f, -0.00327435f,
    -0.00255689f, -0.00059940f, -0.00002768f, -0.00166219f, -0.00338538f,
    -0.00292061f, -0.00087709f, 0.00001044f,  -0.00149764f, -0.00345729f,
    -0.00328220f, -0.00119438f, 0.00001850f,  -0.00131405f, -0.00348660f,
    -0.00363524f, -0.00155007f, -0.00000875f, -0.00111574f, -0.00347042f,
    -0.00397296f, -0.00194211f, -0.00007638f, -0.00090774f, -0.00340654f,
    -0.00428830f, -0.00236757f, -0.00018917f, -0.00069576f, -0.00329345f,
    -0.00457399f, -0.00282266f, -0.00035151f, -0.00048611f, -0.00313042f,
    -0.00482265f, -0.00330272f, -0.00056732f, -0.00028568f, -0.00291758f,
    -0.00502688f, -0.00380224f, -0.00083999f, -0.00010185f, -0.00265590f,
    -0.00517933f, -0.00431488f, -0.00117234f, 0.00005755f,  -0.00234720f,
    -0.00527275f, -0.00483351f, -0.00156654f, 0.00018430f,  -0.00199418f,
    -0.00530008f, -0.00535026f, -0.00202416f, 0.00026983f,  -0.00160040f,
    -0.00525441f, -0.00585652f, -0.00254615f, 0.00030525f,  -0.00117018f,
    -0.00512900f, -0.00634304f, -0.00313292f, 0.00028127f,  -0.00070861f,
    -0.00491718f, -0.00679985f, -0.00378446f, 0.00018819f,  -0.00022144f,
    -0.00461217f, -0.00721629f, -0.00450051f, 0.00001565f,  0.00028498f,
    -0.00420686f, -0.00758090f, -0.00528081f, -0.00024760f, 0.00080384f,
    -0.00369331f, -0.00788122f, -0.00612554f, -0.00061430f, 0.00132795f,
    -0.00306209f, -0.00810346f, -0.00703588f, -0.00109943f, 0.00184986f,
    -0.00230117f, -0.00823188f, -0.00801489f, -0.00172164f, 0.00236201f,
    -0.00139420f, -0.00824769f, -0.00906897f, -0.00250553f, 0.00285687f,
    -0.00031754f, -0.00812725f, -0.01021011f, -0.00348552f, 0.00332702f,
    0.00096466f,  -0.00783871f, -0.01145989f, -0.00471293f, 0.00376535f,
    0.00250957f,  -0.00733580f, -0.01285679f, -0.00626922f, 0.00416515f,
    0.00441334f,  -0.00654532f, -0.01447091f, -0.00829345f, 0.00452025f,
    0.00684868f,  -0.00533996f, -0.01643640f, -0.01104454f, 0.00482512f,
    0.01015476f,  -0.00347102f, -0.01903369f, -0.01506464f, 0.00507499f,
    0.01509041f,  -0.00037102f, -0.02294157f, -0.02170535f, 0.00526594f,
    0.02374743f,  0.00560786f,  -0.03028470f, -0.03551099f, 0.00539494f,
    0.04467873f,  0.02210936f,  -0.05266384f, -0.08702901f, 0.00545996f,
    0.20058614f,  0.36262130f,  0.36262130f,  0.20058614f,  0.00545996f,
    -0.08702901f, -0.05266384f, 0.02210936f,  0.04467873f,  0.00539494f,
    -0.03551099f, -0.03028470f, 0.00560786f,  0.02374743f,  0.00526594f,
    -0.02170535f, -0.02294157f, -0.00037102f, 0.01509041f,  0.00507499f,
    -0.01506464f, -0.01903369f, -0.00347102f, 0.01015476f,  0.00482512f,
    -0.01104454f, -0.01643640f, -0.00533996f, 0.00684868f,  0.00452025f,
    -0.00829345f, -0.01447091f, -0.00654532f, 0.00441334f,  0.00416515f,
    -0.00626922f, -0.01285679f, -0.00733580f, 0.00250957f,  0.00376535f,
    -0.00471293f, -0.01145989f, -0.00783871f, 0.00096466f,  0.00332702f,
    -0.00348552f, -0.01021011f, -0.00812725f, -0.00031754f, 0.00285687f,
    -0.00250553f, -0.00906897f, -0.00824769f, -0.00139420f, 0.00236201f,
    -0.00172164f, -0.00801489f, -0.00823188f, -0.00230117f, 0.00184986f,
    -0.00109943f, -0.00703588f, -0.00810346f, -0.00306209f, 0.00132795f,
    -0.00061430f, -0.00612554f, -0.00788122f, -0.00369331f, 0.00080384f,
    -0.00024760f, -0.00528081f, -0.00758090f, -0.00420686f, 0.00028498f,
    0.00001565f,  -0.00450051f, -0.00721629f, -0.00461217f, -0.00022144f,
    0.00018819f,  -0.00378446f, -0.00679985f, -0.00491718f, -0.00070861f,
    0.00028127f,  -0.00313292f, -0.00634304f, -0.00512900f, -0.00117018f,
    0.00030525f,  -0.00254615f, -0.00585652f, -0.00525441f, -0.00160040f,
    0.00026983f,  -0.00202416f, -0.00535026f, -0.00530008f, -0.00199418f,
    0.00018430f,  -0.00156654f, -0.00483351f, -0.00527275f, -0.00234720f,
    0.00005755f,  -0.00117234f, -0.00431488f, -0.00517933f, -0.00265590f,
    -0.00010185f, -0.00083999f, -0.00380224f, -0.00502688f, -0.00291758f,
    -0.00028568f, -0.00056732f, -0.00330272f, -0.00482265f, -0.00313042f,
    -0.00048611f, -0.00035151f, -0.00282266f, -0.00457399f, -0.00329345f,
    -0.00069576f, -0.00018917f, -0.00236757f, -0.00428830f, -0.00340654f,
    -0.00090774f, -0.00007638f, -0.00194211f, -0.00397296f, -0.00347042f,
    -0.00111574f, -0.00000875f, -0.00155007f, -0.00363524f, -0.00348660f,
    -0.00131405f, 0.00001850f,  -0.00119438f, -0.00328220f, -0.00345729f,
    -0.00149764f, 0.00001044f,  -0.00087709f, -0.00292061f, -0.00338538f,
    -0.00166219f, -0.00002768f, -0.00059940f, -0.00255689f, -0.00327435f,
    -0.00180410f, -0.00009048f, -0.00036171f, -0.00219696f, -0.00312815f,
    -0.00192056f, -0.00017262f, -0.00016364f, -0.00184626f, -0.00295112f,
    -0.00200949f, -0.00026882f, -0.00000412f, -0.00150963f, -0.00274791f,
    -0.00206959f, -0.00037401f, 0.00011856f,  -0.00119129f, -0.00252337f,
    -0.00210026f, -0.00048339f, 0.00020667f,  -0.00089478f, -0.00228242f,
    -0.00210163f, -0.00059250f, 0.00026298f,  -0.00062299f, -0.00202999f,
    -0.00207445f, -0.00069730f, 0.00029062f,  -0.00037809f, -0.00177092f,
    -0.00202007f, -0.00079421f, 0.00029302f,  -0.00016158f, -0.00150985f,
    -0.00194037f, -0.00088016f, 0.00027382f,  0.00002569f,  -0.00125116f,
    -0.00183769f, -0.00095264f, 0.00023679f,  0.00018353f,  -0.00099891f,
    -0.00171472f, -0.00100967f, 0.00018570f,  0.00031232f,  -0.00075673f,
    -0.00157449f, -0.00104983f, 0.00012427f,  0.00041299f,  -0.00052786f,
    -0.00142018f, -0.00107226f, 0.00005609f,  0.00048694f,  -0.00031500f,
    -0.00125515f, -0.00107664f, -0.00001545f, 0.00053598f,  -0.00012040f,
    -0.00108279f, -0.00106314f, -0.00008724f, 0.00056228f,  0.00005423f,
    -0.00090643f, -0.00103237f, -0.00015646f, 0.00056828f,  0.00020770f,
    -0.00072934f, -0.00098540f, -0.00022067f, 0.00055659f,  0.00033930f,
    -0.00055459f, -0.00092362f, -0.00027779f, 0.00052997f,  0.00044885f,
    -0.00038504f, -0.00084874f, -0.00032615f, 0.00049122f,  0.00053657f,
    -0.00022326f, -0.00076270f, -0.00036449f, 0.00044313f,  0.00060312f,
    -0.00007150f, -0.00066762f, -0.00039197f, 0.00038840f,  0.00064955f,
    0.00006831f,  -0.00056572f, -0.00040812f, 0.00032961f,  0.00067719f,
    0.00019463f,  -0.00045929f, -0.00041285f, 0.00026914f,  0.00068767f,
    0.00030631f,  -0.00035058f, -0.00040643f, 0.00020916f,  0.00068280f,
    0.00040254f,  -0.00024179f, -0.00038942f, 0.00015158f,  0.00066455f,
    0.00048290f,  -0.00013501f, -0.00036266f, 0.00009803f,  0.00063500f,
    0.00054735f,  -0.00003215f, -0.00032723f, 0.00004984f,  0.00059625f,
    0.00059614f,  0.00006507f,  -0.00028435f, 0.00000805f,  0.00055038f,
    0.00062983f,  0.00015515f,  -0.00023542f, -0.00002662f, 0.00049944f,
    0.00064926f,  0.00023685f,  -0.00018188f, -0.00005371f, 0.00044534f,
    0.00065550f,  0.00030919f,  -0.00012523f, -0.00007307f, 0.00038988f,
    0.00064977f,  0.00037144f,  -0.00006697f, -0.00008478f, 0.00033468f,
    0.00063347f,  0.00042317f,  -0.00000853f, -0.00008915f, 0.00028115f,
    0.00060807f,  0.00046419f,  0.00004873f,  -0.00008670f, 0.00023051f,
    0.00057512f,  0.00049456f,  0.00010357f,  -0.00007808f, 0.00018375f,
    0.00053616f,  0.00051457f,  0.00015487f,  -0.00006411f, 0.00014165f,
    0.00049272f,  0.00052472f,  0.00020170f,  -0.00004568f, 0.00010476f,
    0.00044626f,  0.00052566f,  0.00024329f,  -0.00002374f, 0.00007341f,
    0.00039817f,  0.00051822f,  0.00027905f,  0.00000075f,  0.00004773f,
    0.00034971f,  0.00050332f,  0.00030858f,  0.00002680f,  0.00002770f,
    0.00030201f,  0.00048197f,  0.00033165f,  0.00005349f,  0.00001311f,
    0.00025606f,  0.00045524f,  0.00034821f,  0.00007995f,  0.00000362f,
    0.00021268f,  0.00042421f,  0.00035838f,  0.00010539f,  -0.00000123f,
    0.00017253f,  0.00038994f,  0.00036242f,  0.00012911f,  -0.00000196f,
    0.00013611f,  0.00035348f,  0.00036071f,  0.00015053f,  0.00000083f,
    0.00010376f,  0.00031580f,  0.00035374f,  0.00016918f,  0.00000651f,
    0.00007568f,  0.00027781f,  0.00034208f,  0.00018472f,  0.00001443f,
    0.00005192f,  0.00024033f,  0.00032636f,  0.00019692f,  0.00002398f,
    0.00003241f,  0.00020405f,  0.00030726f,  0.00020567f,  0.00003453f,
    0.00001699f,  0.00016957f,  0.00028547f,  0.00021096f,  0.00004553f,
    0.00000539f,  0.00013737f,  0.00026166f,  0.00021290f,  0.00005649f,
    -0.00000271f, 0.00010783f,  0.00023650f,  0.00021165f,  0.00006696f,
    -0.00000769f, 0.00008120f,  0.00021061f,  0.00020746f,  0.00007658f,
    -0.00000996f, 0.00005763f,  0.00018456f,  0.00020063f,  0.00008507f,
    -0.00000994f, 0.00003717f,  0.00015885f,  0.00019151f,  0.00009220f,
    -0.00000807f, 0.00001981f,  0.00013394f,  0.00018046f,  0.00009785f,
    -0.00000474f, 0.00000543f,  0.00011018f,  0.00016786f,  0.00010192f,
    -0.00000035f, -0.00000612f, 0.00008786f,  0.00015406f,  0.00010441f,
    0.00000476f,  -0.00001504f, 0.00006720f,  0.00013943f,  0.00010536f,
    0.00001027f,  -0.00002158f, 0.00004835f,  0.00012430f,  0.00010483f,
    0.00001591f,  -0.00002599f, 0.00003139f,  0.00010897f,  0.00010295f,
    0.00002145f,  -0.00002854f, 0.00001634f,  0.00009368f,  0.00009982f,
    0.00002672f,  -0.00002951f, 0.00000318f,  0.00007866f,  0.00009561f,
    0.00003157f,  -0.00002913f, -0.00000816f, 0.00006407f,  0.00009044f,
    0.00003590f,  -0.00002766f, -0.00001777f, 0.00005005f,  0.00008447f,
    0.00003963f,  -0.00002532f, -0.00002577f, 0.00003669f,  0.00007780f,
    0.00004273f,  -0.00002229f, -0.00003229f, 0.00002404f,  0.00007057f,
    0.00004516f,  -0.00001876f, -0.00003746f, 0.00001213f,  0.00006285f,
    0.00004690f,  -0.00001486f, -0.00004141f, 0.00000095f,  0.00005473f,
    0.00004796f,  -0.00001072f, -0.00004428f, -0.00000950f, 0.00004624f,
    0.00004832f,  -0.00000645f, -0.00004616f, -0.00001926f, 0.00003743f,
    0.00004797f,  -0.00000214f, -0.00004716f, -0.00002836f,
};

// Padding length (half of the filter length)
static const int pad_length = NUM_TAPS / 2;
static float *temp_output;
static float *padded_signal;
static fir_f32_t fir;

void init_fir_filter() {
    // Create padded input signal
    padded_signal = malloc((BLOCK_SIZE + 2 * pad_length) * sizeof(float));
    if (padded_signal == NULL) {
        printf("Memory allocation failed\n");
        return;
    }

    // FIR filter state initialization
    float *state = calloc(NUM_TAPS, sizeof(float));
    if (state == NULL) {
        printf("Memory allocation failed\n");
        free(padded_signal);
        return;
    }

    // Copy fir_coefficients to non-const array
    float *coeffs = malloc(NUM_TAPS * sizeof(float));
    if (coeffs == NULL) {
        printf("Memory allocation failed\n");
        free(padded_signal);
        free(state);
        return;
    }
    memcpy(coeffs, fir_coeffs, NUM_TAPS * sizeof(float));

    // Initialize FIR filter structure
    dsps_fir_init_f32(&fir, coeffs, state, NUM_TAPS);

    temp_output = malloc((BLOCK_SIZE + 2 * pad_length) * sizeof(float));
    if (temp_output == NULL) {
        printf("Memory allocation failed\n");
        free(padded_signal);
        free(state);
        free(coeffs);
        return;
    }
}

void clean_fir_filter() {
    // Free allocated memory
    // free(padded_signal);
    // free(state);
    // free(coeffs);
    // free(temp_output);
}

// Function to apply padding to the input signal
static void apply_padding(float *input, float *padded_input,
                          int signal_length) {
    // Apply reflection padding at the beginning
    for (int i = 0; i < pad_length; i++) {
        padded_input[i] = input[pad_length - i - 1];
    }

    // Copy the original signal
    memcpy(padded_input + pad_length, input, signal_length * sizeof(float));

    // Apply reflection padding at the end
    for (int i = 0; i < pad_length; i++) {
        padded_input[pad_length + signal_length + i] =
            input[signal_length - i - 1];
    }
}

void apply_fir_filter(float *input_signal, float *output_signal,
                      int signal_length) {
    // Apply padding to the input signal
    apply_padding(input_signal, padded_signal, signal_length);

    dsps_fir_f32_ae32(&fir, padded_signal, temp_output,
                      signal_length + 2 * pad_length);

    // Copy the valid part of the filtered signal (excluding padding)
    memcpy(output_signal, temp_output + NUM_TAPS - 1,
           signal_length * sizeof(float));
}
